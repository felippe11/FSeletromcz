{% extends "admin/base.html" %}

{% block title %}{{ title }} - FS Eletromcz Admin{% endblock %}

{% block styles %}
<style>
    .image-upload-container {
        margin-top: 10px;
        padding: 15px;
        border: 2px dashed #ddd;
        border-radius: 5px;
        text-align: center;
        transition: all 0.3s;
    }
    .image-upload-container:hover {
        border-color: #a855f7;
        background-color: #faf5ff;
    }
    .preview-image {
        max-width: 100%;
        height: auto;
        max-height: 150px;
        margin: 10px auto;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .ck-editor__editable_inline {
        min-height: 250px;
    }
    /* Estilos responsivos */
    @media (max-width: 640px) {
        .ck-editor__editable_inline {
            min-height: 200px;
        }
        .flex-responsive {
            flex-direction: column;
        }
        .flex-responsive button {
            margin-top: 0.5rem;
            width: 100%;
        }
        .ck.ck-toolbar {
            flex-wrap: wrap;
        }
        .ck.ck-toolbar .ck-toolbar__items {
            flex-wrap: wrap;
        }
    }
    @media (hover: none) {
        /* Melhorar comportamento de toque para dispositivos mobile */
        input, textarea, button, select, .preview-image {
            font-size: 16px !important; /* Previne zoom automático no iOS */
        }
        .image-upload-container {
            padding: 20px;
        }
        .ck.ck-button {
            min-width: 36px; /* Botões maiores para toque */
            min-height: 36px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 px-2 sm:px-0">
        <h1 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-0">{{ title }}</h1>
        <a href="{{ url_for('main.admin_blog_posts') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded flex items-center text-sm">
            <i class="fas fa-arrow-left mr-2"></i> Voltar
        </a>
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm mx-2 sm:mx-0">
        <form method="POST" enctype="multipart/form-data" id="post-form">
            {{ form.hidden_tag() }}
            
            <div class="mb-4">
                {{ form.title.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                {{ form.title(class="shadow appearance-none border rounded w-full py-3 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline", placeholder="Título do post", autocomplete="off") }}
                {% if form.title.errors %}
                    <div class="text-red-500 text-xs mt-1">
                        {% for error in form.title.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-4">
                {{ form.slug.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                <div class="flex flex-col sm:flex-row">
                    {{ form.slug(class="shadow appearance-none border rounded w-full py-3 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline", placeholder="url-amigavel-do-post", autocomplete="off") }}
                    <button type="button" id="generate-slug" class="mt-2 sm:mt-0 sm:ml-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded">
                        <i class="fas fa-sync-alt mr-1"></i> Gerar
                    </button>
                </div>
                <p class="text-gray-500 text-xs mt-1">URL amigável para o post. Clique no botão para gerar automaticamente a partir do título.</p>
                {% if form.slug.errors %}
                    <div class="text-red-500 text-xs mt-1">
                        {% for error in form.slug.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-4">
                {{ form.summary.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                {{ form.summary(class="shadow appearance-none border rounded w-full py-3 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline", rows="3", placeholder="Um breve resumo do post", autocomplete="off") }}
                <p class="text-gray-500 text-xs mt-1">Máximo 300 caracteres. Utilizado na listagem e compartilhamento.</p>
                {% if form.summary.errors %}
                    <div class="text-red-500 text-xs mt-1">
                        {% for error in form.summary.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="content">Conteúdo</label>
                <!-- Campo oculto que será enviado no formulário -->
                <input type="hidden" name="content" id="content-hidden" autocomplete="off">
                <!-- Campo para o CKEditor -->
                <div id="editor" class="w-full">{{ form.content.data|safe if form.content.data else '' }}</div>
                {% if form.content.errors %}
                    <div class="text-red-500 text-xs mt-1">
                        {% for error in form.content.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-6">
                <div class="flex flex-wrap items-center justify-between">
                    {{ form.featured_image.label(class="block text-gray-700 text-sm font-bold mb-2") }}
                    {% if post and post.featured_image %}
                        <span class="text-blue-600 text-xs">Imagem atual: {{ post.featured_image }}</span>
                    {% endif %}
                </div>
                <div class="image-upload-container touch-manipulation">
                    <label for="featured_image" class="cursor-pointer block">
                        <i class="fas fa-upload text-purple-500 text-xl mb-2"></i>
                        <p class="text-gray-600 text-sm sm:text-base">Clique para selecionar ou arraste uma imagem</p>
                        {% if post and post.featured_image %}
                            <img id="image-preview" src="{{ url_for('static', filename='img/products/' + post.featured_image) }}" class="preview-image mx-auto" alt="Preview">
                        {% else %}
                            <img id="image-preview" src="#" class="preview-image mx-auto hidden" alt="Preview">
                        {% endif %}
                    </label>
                    {{ form.featured_image(class="hidden", id="featured_image", autocomplete="off") }}
                </div>
                <p class="text-gray-500 text-xs mt-1">Imagem destacada do post. Formatos: jpg, jpeg, png.</p>
                {% if form.featured_image.errors %}
                    <div class="text-red-500 text-xs mt-1">
                        {% for error in form.featured_image.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-6">
                <label class="flex items-center touch-manipulation">
                    {{ form.published(class="w-5 h-5 mr-2") }}
                    <span class="text-gray-700 text-base">{{ form.published.label }}</span>
                </label>
            </div>
            
            <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
                <button type="submit" id="submit-button" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded focus:outline-none focus:shadow-outline">
                    Salvar
                </button>
                {% if post %}
                    <a href="{{ url_for('main.blog_post', slug=post.slug) }}" target="_blank" class="w-full sm:w-auto text-center inline-block align-baseline py-3 px-4 text-blue-600 hover:text-blue-800 border border-blue-600 rounded">
                        <i class="fas fa-eye mr-1"></i> Visualizar post
                    </a>
                {% endif %}
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script>
<script>
    // Variável para armazenar a instância do editor
    let editorInstance;

    // Inicializar o CKEditor com configurações responsivas
    ClassicEditor
        .create(document.querySelector('#editor'), {
            toolbar: {
                items: [
                    'heading', '|',
                    'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|',
                    'blockQuote', 'insertTable', '|',
                    'undo', 'redo'
                ],
                shouldNotGroupWhenFull: true
            },
            // Configuração responsiva para touch
            uiOptions: {
                touchOffset: 10 // Aumenta área de toque
            }
        })
        .then(editor => {
            // Armazenar a instância do editor para uso posterior
            editorInstance = editor;
            
            // Adicionar um ouvinte para o evento de envio de formulário
            document.getElementById('post-form').addEventListener('submit', function(e) {
                // Obter o conteúdo do editor
                const editorData = editorInstance.getData();
                
                // Atualizar o campo oculto com o conteúdo do editor
                document.getElementById('content-hidden').value = editorData;
            });
        })
        .catch(error => {
            console.error('Erro ao inicializar o editor:', error);
        });

    // Função para gerar slug
    function generateSlug(text) {
        return text.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remover acentos
            .replace(/[^\w\s-]/g, '') // Remover caracteres especiais
            .replace(/[\s_-]+/g, '-') // Substituir espaços e underscores por hífens
            .replace(/^-+|-+$/g, ''); // Remover hífens do início e final
    }

    // Auto-gerar slug a partir do título
    document.getElementById('title').addEventListener('blur', function() {
        const slugField = document.getElementById('slug');
        if (slugField.value === '') {
            slugField.value = generateSlug(this.value);
        }
    });

    // Botão para gerar slug manualmente
    document.getElementById('generate-slug').addEventListener('click', function() {
        const title = document.getElementById('title').value;
        const slugField = document.getElementById('slug');
        
        if (title) {
            slugField.value = generateSlug(title);
        } else {
            alert('Por favor, insira um título primeiro.');
        }
    });

    // Preview de imagem
    document.getElementById('featured_image').addEventListener('change', function(e) {
        const preview = document.getElementById('image-preview');
        const file = e.target.files[0];
        
        if (file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            }
            
            reader.readAsDataURL(file);
        }
    });

    // Drag and drop para upload de imagem
    const dropArea = document.querySelector('.image-upload-container');
    const fileInput = document.getElementById('featured_image');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        dropArea.classList.add('bg-purple-50');
    }

    function unhighlight() {
        dropArea.classList.remove('bg-purple-50');
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length) {
            fileInput.files = files;
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        }
    }

    // Verificar se estamos em um dispositivo móvel para ajustar o CKEditor
    function isMobile() {
        return window.innerWidth <= 640;
    }

    // Ajustar o editor quando a janela é redimensionada
    window.addEventListener('resize', function() {
        if (editorInstance) {
            // Atualize o layout do editor se necessário
            editorInstance.editing.view.change(writer => {
                // Isto força o editor a recalcular seu layout
                const viewRoot = editorInstance.editing.view.document.getRoot();
                writer.addClass('resized', viewRoot);
                writer.removeClass('resized', viewRoot);
            });
        }
    });
    
    // Melhorar a experiência de toque
    if ('ontouchstart' in window || navigator.maxTouchPoints) {
        document.querySelectorAll('button, input, select, textarea, a').forEach(el => {
            el.style.touchAction = 'manipulation';
        });
    }
</script>
{% endblock %}